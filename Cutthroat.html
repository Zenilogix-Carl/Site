<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Scoreboard for Cutthroat</title>
    <style>
        .buttons {
            padding-left: 10px;
            padding-right: 10px;
            padding-top: 3px;
            padding-bottom: 3px;
        }

        input {
            font-size: 20pt;
        }

        table, th, td {
            border: 1px solid grey;
            border-collapse: collapse;
        }

        td {
            padding-left: 5px;
            padding-right: 5px;
        }

        body {
            font-family: Verdana, sans-serif;
            font-size: 20pt;
            padding: 0px;
            margin: 0px;
            overflow-y: hidden;
            width: 100vw;
            height: 100vmin;
        }
    </style>
    <script src="Billiards.js"></script>
    <script>
        // Ball states:
        // 0 = in-play
        // 1..3 = won by player
        // -1 out-of-play
        // Player "number" is 1..3 but where arrays are involved, player 1 occupies element 0, etc.
        class CutthroatPlayer extends Player {
            constructor(name, setupFn) {
                super(name, setupFn);
            }
        }

        const ballCount = 15;
        const playerCount = 3;

        const playerCategoryNames = [
            "Open", "Not Low", "Not Middle", "High", "Not High", "Middle", "Low", "Foul"];

        const ballsToPlay = [
            "1..15", "1..15", "1..15", "1..10", "1..15", "1..5 &amp; 10..15", "6..15"];

        var ballOrder = [];

        var balls = {};

        var ballStates = Array(ballCount).fill(0);
        var playerStates = Array(3).fill(0);

        var players = [
            new CutthroatPlayer("Player 1"),
            new CutthroatPlayer("Player 2"),
            new CutthroatPlayer("Player 3")
        ];

        var currentPlayerIndex = 0;
        var startingPlayerIndex = currentPlayerIndex;

        function clearRackIfConfirmed() {
            if (window.confirm("Reset the current rack?")) {
                clearRack();
            }
        }

        function clearRack() {
            ballStates = Array(ballCount).fill(0);
            ballOrder = [];
            for (var i = 1; i <= ballCount; i++) {
                updateBallState(i);
            }

            updateScore();
        }

        function startMatchIfConfirmed() {
            if (window.confirm("Start a new match (clear current status)?")) {
                startMatch();
            }
        }

        function startMatch() {
            ballStates = Array(ballCount).fill(0);
            clearRack();
            startingPlayerIndex = currentPlayerIndex;
        }

        function nextPlayer() {
            var i = playerCount;
            do {
                currentPlayerIndex = (currentPlayerIndex + 1) % 3;
            } while (--i > 0 && isOut(currentPlayerIndex, playerStates));
        }

        function missedShot() {
            nextPlayer();
            setCurrentPlayer();
            updateBallStates();
        }

        function player1Shooting() {
            if (currentPlayerIndex != 0) {
                currentPlayerIndex = 0;
                setCurrentPlayer();
                updateBallStates();
            }
        }

        function player2Shooting() {
            if (currentPlayerIndex != 1) {
                currentPlayerIndex = 1;
                setCurrentPlayer();
                updateBallStates();
            }
        }

        function player3Shooting() {
            if (currentPlayerIndex != 2) {
                currentPlayerIndex = 2;
                setCurrentPlayer();
                updateBallStates();
            }
        }

        function updateScore() {
            for (var p = 1; p <= 3; p++) {
                var parent = document.getElementById('player' + p + '-balls');
                while (parent.firstChild) {
                    parent.firstChild.remove();
                }
                parent = document.getElementById('player' + p + '-owns');
                while (parent.firstChild) {
                    parent.firstChild.remove();
                }
                parent = document.getElementById('player' + p + '-canShoot');
                while (parent.firstChild) {
                    parent.firstChild.remove();
                }
            }

            var categories = Array(3).fill(0);

            for (var i = 0; i < ballOrder.length; i++) {
                var number = ballOrder[i];
                var ballCategory = getBallCategory(number);
                var ballState = ballStates[number - 1];
                if (ballState > 0) {
                    var playerBall = new BilliardBall(number, '40px');
                    document.getElementById('player' + ballState + '-balls').appendChild(playerBall.element);

                    var playerIndex = ballState - 1;

                    var playerCategory = categories[playerIndex];
                    if (isCategoryUndecided(playerCategory)) {
                        playerCategory |= ballCategory;
                        categories[playerIndex] = playerCategory;
                    }

                    updateOpponentCategory(playerIndex, categories);
                }
            }

            for (var p2 = 0; p2 < players.length; p2++) {
                document.getElementById('player' + (p2 + 1) + '-category').innerHTML = isOut(p2, categories) ? 'Out' : playerCategoryNames[categories[p2]];

                var playerCategory2 = categories[p2];
                if (isCategoryDecided(playerCategory2, categories.length)) {
                    var base = getCategoryBase(playerCategory2);
                    for (var b = 0; b < ballCount / categories.length; b++) {
                        if (ballStates[base + b] == 0) {
                            var ball = new BilliardBall(base + b + 1, '40px');
                            document.getElementById('player' + (p2 + 1) + '-owns').appendChild(ball.element);
                        }
                    }
                }

                if (!isOut(p2, categories)) {
                    for (var b2 = 0; b2 < ballCount; b2++) {
                        if (canPlayBall(p2, categories, ballStates, b2+1)) {
                            var ball2 = new BilliardBall(b2 + 1, '40px');
                            document.getElementById('player' + (p2 + 1) + '-canShoot').appendChild(ball2.element);
                        }
                    }
                }
            }

            playerStates = categories;
        }

        function updateOpponentCategory(playerIndex, categories) {
            var playerCategory = categories[playerIndex];
            if (isCategoryDecided(playerCategory, categories.length)) {
                var outStandingCategory = remainingCategories(playerCategory, categories.length);
                for (var j = 0; j < categories.length; j++) {
                    if (j != playerIndex && isCategoryUndecided(categories[j])) {
                        categories[j] |= outStandingCategory;
                        if (isCategoryDecided(categories[j], categories.length)) {
                            updateOpponentCategory(j, categories);
                        }
                    }
                }
            }
        }

        function canPlayBall(playerIndex, categories, ballStates, number) {
            if (ballStates[number-1] !=  0) {
                return false;
            }
            var playerCategory = categories[playerIndex];
            if (isCategoryDecided(playerCategory, categories.length)) {
                return (playerCategory & getBallCategory(number)) != 0;
            }

            return true;
        }

        function getBallCategory(number) {
            return (number > 10) ? 4 : ((number > 5) ? 2 : 1);
        }

        // Returns true if exactly one bit set
        function isSingleBit(n) {
             return (n != 0) && ((n & (n-1)) == 0);
        }

        // Returns true if all but one bit is set
        function isAllButOneBitSet(n, width) {
            return isSingleBit(((1 << width)-1) & ~n);
        }

        // Returns true if category undecided
        function isCategoryUndecided(category) {
            return isSingleBit(category) || (category == 0);
        }

        // Returns true if category decided
        function isCategoryDecided(category, players) {
            return isAllButOneBitSet(category, players);
        }

        // gets remaining categories from that given
        function remainingCategories(category, width) {
            return ~category & ((1 << width) - 1);
        }

        function getCategoryBase(category) {
            var base = -1;
            switch (category) {
            case 3:
                base = 10;
                break;
            case 5:
                base = 5;
                break;
            case 6:
                base = 0;
                break;
            default:
            }

            return base;
        }

        function isOut(playerIndex, categories) {
            var category = categories[playerIndex];
            var base = getCategoryBase(category);
            if (base < 0) {
                return false;
            }
            if (isCategoryDecided(category, categories.length)) {
                for (var i = 0; i < ballCount / categories.length; i++) {
                    if (ballStates[base+i] == 0) {
                        return false;
                    }
                }
                return true;
            }
            return false;
        }

        function nextRack() {
            if (window.confirm("Advance to the next rack?")) {

                clearRack();
                updateScore();
            }
        }

        function setCurrentPlayer() {
            var player1Cue = document.getElementById("player1-cue");
            var player2Cue = document.getElementById("player2-cue");
            var player3Cue = document.getElementById("player3-cue");
            var player1Input = document.getElementById("player1-input");
            var player2Input = document.getElementById("player2-input");
            var player3Input = document.getElementById("player3-input");
            switch (currentPlayerIndex) {
                case 0:
                    player1Cue.style.visibility = "visible";
                    player2Cue.style.visibility = "hidden";
                    player3Cue.style.visibility = "hidden";
                    player1Input.style.fontWeight = "bold";
                    player2Input.style.fontWeight = "normal";
                    player3Input.style.fontWeight = "normal";
                    break;
                case 1:
                    player1Cue.style.visibility = "hidden";
                    player2Cue.style.visibility = "visible";
                    player3Cue.style.visibility = "hidden";
                    player1Input.style.fontWeight = "normal";
                    player2Input.style.fontWeight = "bold";
                    player3Input.style.fontWeight = "normal";
                    break;
                case 2:
                    player1Cue.style.visibility = "hidden";
                    player2Cue.style.visibility = "hidden";
                    player3Cue.style.visibility = "visible";
                    player1Input.style.fontWeight = "normal";
                    player2Input.style.fontWeight = "normal";
                    player3Input.style.fontWeight = "bold";
                    break;
            }
        }

        function updateBallStates() {
            for (var i = 1; i <= ballCount; i++) {
                updateBallState(i);
            }
        }

        function updateBallState(number) {

            var currentBallState = ballStates[number - 1];
            var ball = balls[number];

            switch (currentBallState) {
                case 0:
                    ball.showNormal();
                    break;

                case -1:
                    ball.showFoul();
                    break;

                default:
                    ball.showPocketed(currentBallState == (currentPlayerIndex + 1));
                    break;
            }
        }

        function ballClick(number) {

            var currentBallState = ballStates[number - 1];

            switch (currentBallState) {
                case 0:
                    // ball in-play (0) so give to current player
                    currentBallState = currentPlayerIndex + 1;

                    ballOrder = ballOrder.filter(e => !(e === number));
                    ballOrder.push(number);

                     break;
                case -1:
                    // currently foul so give to next player
                    currentBallState = ((currentPlayerIndex + 1) % 3) + 1;
                    break;
                default:
                    if (currentBallState == currentPlayerIndex + 1) {
                        // currently won by current player, mark as foul
                        currentBallState = -1;
                    } else {
                        // give to next player
                        currentBallState = ((currentBallState) % 3) + 1;
                        if (currentBallState == currentPlayerIndex + 1) {
                            // back to current so mark in-play
                            currentBallState = 0;
                        }
                    }
            }

            ballStates[number - 1] = currentBallState;

            updateBallState(number);
            updateScore();
        }

        function addMiss(parentId, size) {
            var parentElement = document.getElementById(parentId);
            parentElement.appendChild(new CueBall(size, "End Turn", missedShot).element);
        }


        function addRack(parentId, size) {
            var parentElement = document.getElementById(parentId);
            parentElement.appendChild(new Rack(size, "New Rack", nextRack).element);
        }

        function addBalls(elementId) {
            var parentElement = document.getElementById(elementId);
            for (var i = 1; i <= ballCount; i++) {

                balls[i] = new BilliardBallWithState(i, '20%', ballClick, 'Foul');
                parentElement.appendChild(balls[i].element);
            }

            addMiss(elementId, '20%');
            addRack(elementId, '20%');
        }

        function initialCaps(str) {
            return str[0].toUpperCase() + str.substring(1);
        }

        function onLoad() {
            addBalls("balls");
            for (var i = 0; i < 3; i++) {
                var playerPrefix = "player" + (i + 1);
                var player = players[i];

                bindInput(player,
                    "name",
                    document.getElementById(playerPrefix + "-input"),
                    function (player) {
                        var name = player.name;
                        var uc = initialCaps(name);
                        if (uc != name) {
                            player.name = uc;
                        };
                    });
            }

            clearRack();
            setCurrentPlayer();
        }

    </script>
</head>
<body onload='onLoad()'>
    <div style="background-color: lightblue; padding: 20px;">
        <!--<button onclick="clearRackIfConfirmed()">Clear Rack</button>-->
        <table>
            <tr>
                <td>Player/Current Shooter</td>
                <td>Category</td>
                <td>Protect</td>
                <td>Play</td>
                <td>Pocketed</td>
            </tr>
            <tr>
                <td>
                    <div style="display: flex; white-space: nowrap">
                        <button style="vertical-align: middle; background: transparent; border: gray;" onclick="player1Shooting()">
                            <svg id="player1-cue" width="25" height="25" style="vertical-align: bottom; visibility: visible; filter: drop-shadow(3px 3px 3px)"><circle cx="11" cy="11" r="10" style="fill: white; stroke: black; stroke-width: 1px" /></svg>
                        </button>
                        &nbsp;
                        <input type="text" id="player1-input" size="12" style="background: transparent; border: transparent;" />
                    </div>
                </td>
                <td style="text-align: center"><span id="player1-category"></span></td>
                <td><div style="padding-top: 3px; padding-left: 3px" id="player1-owns"></div></td>
                <td><div style="padding-top: 3px; padding-left: 3px" id="player1-canShoot"></div></td>
                <td><div style="padding-top: 3px; padding-left: 3px" id="player1-balls"></div></td>
            </tr>
            <tr>
                <td>
                    <div style="display: flex; white-space: nowrap">
                        <button style="vertical-align: middle; background: transparent; border: gray;" onclick="player2Shooting()">
                            <svg id="player2-cue" width="25" height="25" style="vertical-align: bottom; visibility: hidden; filter: drop-shadow(3px 3px 3px)"><circle cx="11" cy="11" r="10" style="fill: white; stroke: black; stroke-width: 1px" /></svg>
                        </button>
                        &nbsp;
                        <input type="text" id="player2-input" size="12" style="background: transparent; border: transparent;"/>
                    </div>
                </td>
                <td style="text-align: center"><span id="player2-category"></span></td>
                <td><div style="padding-top: 3px; padding-left: 3px" id="player2-owns"></div></td>
                <td><div style="padding-top: 3px; padding-left: 3px" id="player2-canShoot"></div></td>
                <td><div style="padding-top: 3px;padding-left: 3px" id="player2-balls"></div></td>
            </tr>
            <tr>
                <td>
                    <div style="display: flex; white-space: nowrap">
                        <button style="vertical-align: middle; background: transparent; border: gray;" onclick="player3Shooting()">
                            <svg id="player3-cue" width="25" height="25" style="vertical-align: bottom; visibility: hidden; filter: drop-shadow(3px 3px 3px)"><circle cx="11" cy="11" r="10" style="fill: white; stroke: black; stroke-width: 1px" /></svg>
                        </button>
                        &nbsp;
                        <input type="text" id="player3-input" size="12" style="background: transparent; border: transparent;"/>
                    </div>
                </td>
                <td style="text-align: center"><span id="player3-category"></span></td>
                <td><div style="padding-top: 3px; padding-left: 3px" id="player3-owns"></div></td>
                <td><div style="padding-top: 3px; padding-left: 3px" id="player3-canShoot"></div></td>
                <td><div style="padding-top: 3px;padding-left: 3px" id="player3-balls"></div></td>
            </tr>
        </table>
        <div id="balls" style="padding: 10px; height: 90vmin; aspect-ratio: 1 / 1; ">
        </div>
    </div>
</body>
</html>