<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <style>
        .buttons {
            padding-left: 10px;
            padding-right: 10px;
            padding-top: 3px;
            padding-bottom: 3px;
        }

        input {
            font-size: 20pt;
        }

        button {
            font-size: 18pt;
        }

        table, th, td {
            border: 1px solid grey;
            border-collapse: collapse;
        }
        td {
             padding-left: 5px;
             padding-right: 5px;
             padding-top: 1px;
             padding-bottom: 1px;
        }
        body {
            font-family: Verdana, sans-serif;
            font-size: 20pt;
            padding: 0px;
            margin: 0px;
            overflow-x: hidden;
            overflow-y: hidden;
        }
    </style>
    <script>
        const ballCount = 9;
        const values = [1, 1, 1, 1, 1, 1, 1, 1, 2];

        const player1 = "player1";
        const player2 = "player2";

        const states = {
            "normal": { "dim": false, "hideCheck": true, "hideDead" : true },
            "won": { "dim": true, "hideCheck": false, "hideDead": true },
            "lost": { "dim": true, "hideCheck": true, "hideDead": true },
            "dead": { "dim": true, "hideCheck": true, "hideDead": false }
        };

        var ballStates = Array(ballCount).fill("normal");

        var player1Name = "Self";
        var player2Name = "Opponent";

        var cycle = {
            "normal": "won",
            "won": "dead",
            "dead": "lost",
            "lost":"normal"
        };

        var invert = {
            "normal": "normal",
            "won": "lost",
            "dead": "dead",
            "lost": "won"
        };

        var matchInnings = 0;
        var currentInnings = 0;
        var matchplayer1Defensives = 0;
        var matchplayer2Defensives = 0;
        var currentplayer1Defensives = 0;
        var currentplayer2Defensives = 0;
        var currentPlayer = player1;
        var startingPlayer = currentPlayer;
        var player1Score = 0;
        var player2Score = 0;
        var player1RackScore = 0;
        var player2RackScore = 0;

        function clearRackIfConfirmed() {
            if (window.confirm("Reset the current rack?")) {
                clearRack();
            }
        }

        function clearRack() {
            ballStates = Array(ballCount).fill("normal");
            for (var i = 1; i <= ballCount; i++) {
                updateBallState('main', i);
            }

            currentInnings = 0;
            currentplayer1Defensives = 0;
            currentplayer2Defensives = 0;
            updateScore();
            setInnings();
            setplayer1Defensives();
            setplayer2Defensives();
        }

        function startMatchIfConfirmed() {
            if (window.confirm("Start a new match (clear current status)?")) {
                startMatch();
            }
        }

        function startMatch() {
            ballStates = Array(ballCount).fill("normal");
            player1Score = 0;
            player2Score = 0;
            player1RackScore = 0;
            player2RackScore = 0;
            clearRack();
            matchInnings = 0;
            currentInnings = 0;
            currentplayer1Defensives = 0;
            currentplayer2Defensives = 0;
            matchplayer1Defensives = 0;
            matchplayer2Defensives = 0;
            startingPlayer = currentPlayer;
            setInnings();
            setplayer1Defensives();
            setplayer2Defensives();
        }

        function switchPlayerBalls() {
            for (var i = 0; i < ballCount; i++) {
                ballStates[i] = invert[ballStates[i]];
                updateBallState('main', i+1);
            }
        }

        function missedShot() {
            if (currentPlayer == player1) {
                currentPlayer = player2;
            } else {
                currentPlayer = player1;
            }
            switchPlayerBalls();
            setCurrentPlayer();

            if (currentPlayer == startingPlayer) {
                addInning();
            }
        }

        function player1Shooting() {
            if (currentPlayer != player1) {
                switchPlayerBalls();
                currentPlayer = player1;
                setCurrentPlayer();
            }
        }

        function player2Shooting() {
            if (currentPlayer != player2) {
                switchPlayerBalls();
                currentPlayer = player2;
                setCurrentPlayer();
            }
        }

        function addplayer1Defensive() {
            currentplayer1Defensives++;
            setplayer1Defensives();
        }

        function removeplayer1Defensive() {
            if (currentplayer1Defensives > 0) {
                currentplayer1Defensives--;
            }
            setplayer1Defensives();
        }

        function addplayer2Defensive() {
            currentplayer2Defensives++;
            setplayer2Defensives();
        }

        function removeplayer2Defensive() {
            if (currentplayer2Defensives > 0) {
                currentplayer2Defensives--;
            }
            setplayer2Defensives();
        }

        function addInning() {
            currentInnings = currentInnings + 1;
            setInnings();
        }

        function removeInning() {
            if (currentInnings > 0) {
                currentInnings = currentInnings - 1;
            }
            setInnings();
        }

        function setInnings() {
            var matchInningsElement = document.getElementById("match-innings");
            matchInningsElement.innerHTML = currentInnings + matchInnings;
            var inningsElement = document.getElementById("rack-innings");
            inningsElement.innerHTML = currentInnings;
        }

        function updateScore() {
            player1RackScore = 0;
            player2RackScore = 0;
            var parent1 = document.getElementById("player1-balls");
            while (parent1.firstChild) {
                parent1.firstChild.remove();
            }
            var parent2 = document.getElementById("player2-balls");
            while (parent2.firstChild) {
                parent2.firstChild.remove();
            }
            for (var i = 0; i < 9; i++) {
                var ballState = ballStates[i];
                if ((currentPlayer == player1 && ballState == "won") || (currentPlayer == player2 && ballState == "lost")) {
                    player1RackScore += values[i];
                    addPoolBall("player1-balls", i+1, '30px');
                }
                if ((currentPlayer == player1 && ballState == "lost") || (currentPlayer == player2 && ballState == "won")) {
                    player2RackScore+=values[i];
                    addPoolBall("player2-balls", i + 1, '30px');
                }
            }

            var player1Element = document.getElementById("player1-score");
            var player2Element = document.getElementById("player2-score");

            player1Element.innerHTML = player1Score + player1RackScore;
            player2Element.innerHTML = player2Score + player2RackScore;

            onPlayer1GoalChange();
            onPlayer2GoalChange();
        }

        function setplayer1Defensives() {
            var sdElement = document.getElementById("player1-defensives");
            sdElement.innerHTML = currentplayer1Defensives + matchplayer1Defensives;
        }

        function setplayer2Defensives() {
            var odElement = document.getElementById("player2-defensives");
            odElement.innerHTML = currentplayer2Defensives + matchplayer2Defensives;
        }

        function nextRack() {
            if (window.confirm("Advance to the next rack?")) {
                for (var i = 0; i < 9; i++) {
                    var ballState = ballStates[i];
                    if ((currentPlayer == player1 && ballState == "won") || (currentPlayer == player2 && ballState == "lost")) {
                        player1Score += values[i];
                    }
                    if ((currentPlayer == player1 && ballState == "lost") || (currentPlayer == player2 && ballState == "won")) {
                        player2Score += values[i];
                    }
                }

                matchInnings += currentInnings;
                matchplayer1Defensives += currentplayer1Defensives;
                matchplayer2Defensives += currentplayer2Defensives;
                clearRack();
                updateScore();
            }
        }

        function setCurrentPlayer() {
            var player1Cue = document.getElementById("player1-cue");
            var player2Cue = document.getElementById("player2-cue");
            if (currentPlayer == player1) {
                player1Cue.style.visibility = "visible";
                player2Cue.style.visibility = "hidden";
            } else {
                player1Cue.style.visibility = "hidden";
                player2Cue.style.visibility = "visible";
            }
        }

        function updateBallState(group, number) {
            var ballId = getBallGraphicId(group, number);
            var checkId = getCheckId(group, number);
            var foulId = getFoulId(group, number);

            var ballElem = document.getElementById(ballId);
            var checkElem = document.getElementById(checkId);
            var deadElem = document.getElementById(foulId);

            var currentBallState = ballStates[number - 1];

            dimElement(ballElem, states[currentBallState]["dim"]);
            hideElement(checkElem, states[currentBallState]["hideCheck"]);
            hideElement(deadElem, states[currentBallState]["hideDead"]);
        }
        
        function ballClick(number) {
            var currentBallState = ballStates[number - 1];

            var nextBallState = cycle[currentBallState];
            ballStates[number - 1] = nextBallState;

            updateBallState('main', number);
            updateScore();
        }

        function dimElement(elem,dim) {
            if (dim) {
                elem.style.filter = "brightness(30%)";
            } else {
                elem.style.filter = "drop-shadow(10px 10px 5px)";
            }
        }

        function hideElement(elem, hide) {
            if (hide) {
                elem.style.visibility = "hidden";
            } else {
                elem.style.visibility = "visible";
            }
        }

        function getBallId(group, number) { return "ball-" + group + "-" + number; }
        function getBallGraphicId(group, number) { return "ball-graphic-" + group + "-" + number; }
        function getCheckId(group, number) { return "ball-check-" + group + "-" + number; }
        function getFoulId(group, number) { return "ball-foul-mark-" + group + "-" + number; }

        function addBall(parentId, number, color, isStripe, size, group) {

            var ballElementId;
            var ballId;
            var checkId;
            var foulId;

            if (!(group === undefined)) {
                ballElementId = getBallId(group, number);
                ballId = getBallGraphicId(group, number);
                checkId = getCheckId(group, number);
                foulId = getFoulId(group, number);
            }

            var parentElement = document.getElementById(parentId);

            var svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute('id', ballElementId);
            svg.setAttribute('viewBox', '0 0 120 120');
            svg.setAttribute('width', size);
            svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
            //svg.setAttribute('width', 120);
            //svg.setAttribute('height', 120);
            if (!(group === undefined)) {
                svg.setAttribute('onclick', "ballClick(" + number + ");");
            }
            var g = document.createElementNS("http://www.w3.org/2000/svg", 'g');
            if (!(ballId === undefined)) {
                g.setAttribute('id', ballId);
            }
            var circle = document.createElementNS("http://www.w3.org/2000/svg", 'circle');

            if (isStripe) {
                circle.setAttribute('cx', 50);
                circle.setAttribute('cy', 50);
                circle.setAttribute('r', 48);
                circle.setAttribute("style", "fill: white;");
                g.appendChild(circle);

                var path = document.createElementNS("http://www.w3.org/2000/svg", 'path');
                path.setAttribute('d', "M 16 16 L 84 16 A 50 50 0 0 1 84 84 L 16 84  A 50 50 0 0 1 16 16 ");
                path.setAttribute("style", "fill: " + color + "; stroke-width: 1; stroke: grey;");
                g.appendChild(path);

                circle = document.createElementNS("http://www.w3.org/2000/svg", 'circle');
                circle.setAttribute('cx', 50);
                circle.setAttribute('cy', 50);
                circle.setAttribute('r', 48);
                circle.setAttribute("style", "fill: transparent; stroke-width: 1; stroke: grey;");
                g.appendChild(circle);

            } else {
                circle.setAttribute('cx',50);
                circle.setAttribute('cy', 50);
                circle.setAttribute('r', 48);
                circle.setAttribute("style", "fill: " + color + "; stroke-width: 1; stroke: grey;");
                g.appendChild(circle);
            }

            circle = document.createElementNS("http://www.w3.org/2000/svg", 'circle');
            circle.setAttribute('cx', 50);
            circle.setAttribute('cy', 50);
            circle.setAttribute('r', 27);
            circle.setAttribute("style", "fill: white; stroke-width: 1; stroke: grey;");
            g.appendChild(circle);
            var text = document.createElementNS("http://www.w3.org/2000/svg", 'text');
            text.setAttribute("x", 50);
            text.setAttribute("y", 53);
            text.setAttribute("text-anchor", "middle");
            text.setAttribute("dominant-baseline", "middle");
            text.setAttribute("font-weight", "bold");
            text.setAttribute("font-size", number > 9 ? "32px" : "40px");
            text.innerHTML = number;
            g.appendChild(text);
            svg.appendChild(g);

            if (!(group === undefined)) {
                text = document.createElementNS("http://www.w3.org/2000/svg", 'text');
                text.setAttribute("style", "visibility: hidden; filter: drop-shadow(10px 10px 5px)");
                text.setAttribute("x", 50);
                text.setAttribute("y", 50);
                text.setAttribute("text-anchor", "middle");
                text.setAttribute("dominant-baseline", "middle");
                text.setAttribute("font-size", "30px");
                text.setAttribute("fill", "red");
                text.setAttribute("stroke-width", "1");
                text.setAttribute("stroke", "white");
                text.innerHTML = "DEAD";
                text.setAttribute("id", foulId);
                svg.appendChild(text);
                text = document.createElementNS("http://www.w3.org/2000/svg", 'text');
                text.setAttribute("style", "visibility: hidden; filter: drop-shadow(10px 10px 5px)");
                text.setAttribute("x", 40);
                text.setAttribute("y", 90);
                text.setAttribute("font-size", "80px");
                text.setAttribute("fill", "green");
                text.setAttribute("stroke-width", "1");
                text.setAttribute("stroke", "white");
                text.innerHTML = "&#x2714;";
                text.setAttribute("id", checkId);
                svg.appendChild(text);
            }
            parentElement.appendChild(svg);

            if (!(group === undefined)) {
                updateBallState(group, number);
            }
        }

        function addMiss(parentId, size) {
            var parentElement = document.getElementById(parentId);

            var svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute('viewBox', '0 0 120 120');
            svg.setAttribute('width', size);
            svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
            //svg.setAttribute('width', 120);
            //svg.setAttribute('height', 120);
            svg.setAttribute('onclick', "missedShot();");
            svg.setAttribute("style", "filter: drop-shadow(10px 10px 5px)");
            var g = document.createElementNS("http://www.w3.org/2000/svg", 'g');
            var circle = document.createElementNS("http://www.w3.org/2000/svg", 'circle');

            circle.setAttribute('cx', 50);
            circle.setAttribute('cy', 50);
            circle.setAttribute('r', 48);
            circle.setAttribute("style", "fill: white; stroke-width: 1; stroke: grey ;");
            g.appendChild(circle);

            svg.appendChild(g);
            var text = document.createElementNS("http://www.w3.org/2000/svg", 'text');
            text.setAttribute("style", "filter: drop-shadow(10px 10px 5px)");
            text.setAttribute("x", 50);
            text.setAttribute("y", 50);
            text.setAttribute("text-anchor", "middle");
            text.setAttribute("dominant-baseline", "middle");
            text.setAttribute("font-size", "20px");
            text.setAttribute("font-weight", "bold");
            text.setAttribute("fill", "red");
            text.setAttribute("stroke", "darkred");
            text.setAttribute("stroke-width", "1");
            text.innerHTML = "End Turn";
            svg.appendChild(text);
            parentElement.appendChild(svg);
        }

        function addRack(parentId, size) {
            var parentElement = document.getElementById(parentId);

            var svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute('viewBox', '0 0 120 120');
            svg.setAttribute('width', size);
            svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
            //svg.setAttribute('width', 120);
            //svg.setAttribute('height', 120);
            svg.setAttribute('onclick', "nextRack();");
            svg.setAttribute("style", "filter: drop-shadow(10px 10px 5px)");
            var g = document.createElementNS("http://www.w3.org/2000/svg", 'g');

            var path = document.createElementNS("http://www.w3.org/2000/svg", 'path');
            path.setAttribute('d', "M 10 80 L 50 8 L 90 80 Z");
            path.setAttribute("style", "fill: transparent; stroke-width: 8; stroke: brown;");
            g.appendChild(path);

            svg.appendChild(g);
            var text = document.createElementNS("http://www.w3.org/2000/svg", 'text');
            text.setAttribute("style", "filter: drop-shadow(10px 10px 5px)");
            text.setAttribute("x", 50);
            text.setAttribute("y", 50);
            text.setAttribute("text-anchor", "middle");
            text.setAttribute("dominant-baseline", "middle");
            text.setAttribute("font-size", "18px");
            text.setAttribute("font-weight", "bold");
            text.setAttribute("fill", "yellow");
            text.setAttribute("stroke", "white");
            text.setAttribute("stroke-width", "1");
            text.innerHTML = "Next Rack";
            svg.appendChild(text);
            parentElement.appendChild(svg);
        }

        function addPoolBall(elementId, number, size, group) {
            var colors = ["yellow", "blue", "red", "purple", "orange", "green", "brown", "black"];
            var color = colors[(number - 1) % 8];
            var isStripe = (((number - 1) / 8) >= 1);
            addBall(elementId, number, color, isStripe, size, group);
        }

        function addBalls(elementId, group) {
            for (var i = 1; i <= ballCount; i++) {
                addPoolBall(elementId, i, '20%', group);
            }

            addMiss(elementId, '20%');
            addRack(elementId, '20%');
        }

        function onLoad() {
            addBalls("balls", "main");
            document.getElementById("player1-input").value = player1Name;
            document.getElementById("player2-input").value = player2Name;

        }

        function onPlayer1Change() {
            player1Name = document.getElementById("player1-input").value;
        }

        function onPlayer2Change() {
            player2Name = document.getElementById("player2-input").value;
        }

        function onPlayer1GoalChange() {
            var rem = document.getElementById("player1-goal").value - player1Score - player1RackScore;
            document.getElementById("player1-needs").innerHTML = rem < 0 ? 0 : rem;
        }

        function onPlayer2GoalChange() {
            var rem = document.getElementById("player2-goal").value - player2Score - player2RackScore;
            document.getElementById("player2-needs").innerHTML = rem < 0 ? 0 : rem;
        }
    </script>
</head>
<body onload='onLoad()'>
<div style="background-color: lightblue; padding: 20px; min-height: 100vh;  ">
    <table >
        <tr>
            <td>
                <button onclick="startMatchIfConfirmed()">Start Match</button>
            </td>
            <td style="text-align: center">Total Innings</td>
            <td style="text-align: center">Rack Innings</td>

        </tr>
        <tr>
            <td>
                <button onclick="clearRackIfConfirmed()">Clear Rack</button>
            </td>
            <td style="text-align: center">
                <span id="match-innings">0</span>
            </td>
            <td style="text-align: center">
                <span id="rack-innings">0</span>
                <button class="buttons" onclick="addInning()"><b>+</b></button>
                <button class="buttons" onclick="removeInning()"><b>-</b></button>
            </td>

        </tr>
    </table>
    <table>
        <tr>
            <td>Player/Current Shooter</td>
            <td colspan="2">Needed to Win</td>
            <td>Score</td>
            <td>Current Rack</td>
            <td>Defensives</td>
        </tr>
        <tr>
            <td>
                <div style="display: flex; white-space: nowrap">
                    <button style="vertical-align: middle" onclick="player1Shooting()">
                        <svg id="player1-cue" width="25" height="25" style="vertical-align: bottom; visibility: visible; filter: drop-shadow(3px 3px 3px)"><circle cx="11" cy="11" r="10" style="fill: white; stroke: black; stroke-width: 1px" /></svg>
                    </button>
                    &nbsp;
                    <input type="text" id="player1-input" size="15" oninput="onPlayer1Change()" />
                </div>
            </td>
            <td style="text-align: right">
                <span id="player1-needs"></span>/
            </td>
            <td>
                <input type="text" id="player1-goal" size="2" oninput="onPlayer1GoalChange()" />
            </td>
            <td style="text-align: center"><span id="player1-score">0</span></td>
            <td><div id="player1-balls" style="padding-top: 3px; padding-left: 3px; padding-bottom: 0px"></div></td>
            <td style="text-align: center">
                <span id="player1-defensives">0</span>
                <button class="buttons" onclick="addplayer1Defensive()"><b>+</b></button>
                <button class="buttons" onclick="removeplayer1Defensive()"><b>-</b></button>
            </td>
        </tr>
        <tr>
            <td>
                <div style="display: flex; white-space: nowrap">
                    <button style="vertical-align: middle" onclick="player2Shooting()">
                        <svg id="player2-cue" width="25" height="25" style="vertical-align: bottom; visibility: hidden; filter: drop-shadow(3px 3px 3px)"><circle cx="11" cy="11" r="10" style="fill: white; stroke: black; stroke-width: 1px" /></svg>
                    </button>
                    &nbsp;
                    <input type="text" id="player2-input" size="15" oninput="onPlayer2Change()" />
                </div>
            </td>
            <td style="text-align: right">
                <span id="player2-needs"></span>/
            </td>
            <td>
                <input type="text" id="player2-goal" size="2" oninput="onPlayer2GoalChange()" />
            </td>
            <td style="text-align: center"><span id="player2-score">0</span></td>
            <td><div id="player2-balls" style="padding-top: 3px; padding-left: 3px; padding-bottom: 0px"></div></td>
            <td style="text-align: center">
                <span id="player2-defensives">0</span>
                <button class="buttons" onclick="addplayer2Defensive()"><b>+</b></button>
                <button class="buttons" onclick="removeplayer2Defensive()"><b>-</b></button>
            </td>
        </tr>
    </table>
    <div id="balls" style="background-color: lightblue; padding: 10px; max-width: 800px; max-height: 95%; aspect-ratio: 4 / 3; " >
    </div>
</div>
</body>
</html>