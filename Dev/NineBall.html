<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <link rel="stylesheet" href="styles.css">
    <script src="Billiards.js"></script>
    <script>
        window.addEventListener("resize", onResize);

        class NineBallPlayer extends PlayerWithScore {
            constructor(name, setupFn) {
                super(name, setupFn);
                this.displayName = name;
                this.scores = [];
                this.rackTimeouts = [];
                this.nineSnaps = [];
                this.nineRuns = [];
                this.nineSnap = false;
                this.nineRun = false;
            }
        }

        var started = false;

        const ballCount = 9;
        const maxTimeouts = 2;
        const apa = [1, 1, 1, 1, 1, 1, 1, 1, 2];
        const traditional = [0, 0, 0, 0, 0, 0, 0, 0, 1];

        const player1 = "player1";
        const player2 = "player2";

        var ballSizeLarge = '20%';
        var ballSizeSmall = '32px';

        var qs = location.search.substring(1).split('&');
        var qqs = {};
        qs.forEach((nvp) => {
            var e = nvp.split('=');
            if (e.length == 2) {
                qqs[e[0].trim()] = e[1].trim();
            }
        });
        var isApa = (!(qqs['style'] === undefined) && qqs['style'].toLowerCase() == 'apa');
        var values = isApa ? apa : traditional;

        var balls = {};
        var ballStates = Array(ballCount).fill("normal");

        var innings = [];

        var player1Name = "Self";
        var player2Name = "Opponent";

        var cycle = {
            "normal": "won",
            "won": "dead",
            "dead": "lost",
            "lost": "normal"
        };

        var invert = {
            "normal": "normal",
            "won": "lost",
            "dead": "dead",
            "lost": "won"
        };

        var matchInnings = 0;
        var currentInnings = 0;
        var matchplayer1Defensives = 0;
        var matchplayer2Defensives = 0;
        var currentplayer1Defensives = 0;
        var currentplayer2Defensives = 0;
        var currentPlayer = player1;
        var startingPlayer = currentPlayer;
        var player1Score = 0;
        var player2Score = 0;
        var player1RackScore = 0;
        var player2RackScore = 0;

        var matchTime = new Date();
        var shotTime = matchTime;

        var players = {
            player1: new NineBallPlayer("Self"),
            player2: new NineBallPlayer("Opponent")
        }


        function clearRackIfConfirmed() {
            confirmBox("Reset the current rack?", clearRack);
        }

        function clearRack() {
            ballStates = Array(ballCount).fill("normal");
            for (var i = 1; i <= ballCount; i++) {
                updateBallState(i);
            }

            for (const [key, value] of Object.entries(players)) {
                value.rackScore = 0;
                value.rackDefensives = 0;
                value.timeouts = 0;
                value.nineSnap = false;
                value.nineRun = false;
            }

            currentInnings = 0;
            currentplayer1Defensives = 0;
            currentplayer2Defensives = 0;
            updateScore();
            setInnings();
            setplayer1Defensives();
            setplayer2Defensives();

            players[player1].timeouts = 0;
            players[player1].nineSnap = false;
            players[player1].nineRun = false;
            players[player2].timeouts = 0;
            players[player2].nineSnap = false;
            players[player2].nineRun = false;

            shotTime = new Date();
        }

        function startMatchIfConfirmed() {
            confirmBox("Start a new match (clear current status)?", startMatch);
        }

        function startMatch() {
            ballStates = Array(ballCount).fill("normal");
            for (const [key, value] of Object.entries(players)) {
                value.score = 0;
                value.matchDefensives = 0;
                value.scores = [];
                value.timeouts = [];
                value.nineSnaps = [];
                value.nineRuns = [];
            }
            player1Score = 0;
            player2Score = 0;
            player1RackScore = 0;
            player2RackScore = 0;
            clearRack();
            matchInnings = 0;
            currentInnings = 0;
            currentplayer1Defensives = 0;
            currentplayer2Defensives = 0;
            matchplayer1Defensives = 0;
            matchplayer2Defensives = 0;
            startingPlayer = currentPlayer;
            setInnings();
            setplayer1Defensives();
            setplayer2Defensives();
            matchTime = new Date();
            shotTime = new Date();
            started = true;

            innings = [];
        }

        function switchPlayerBalls() {
            for (var i = 0; i < ballCount; i++) {
                ballStates[i] = invert[ballStates[i]];
                updateBallState(i + 1);
            }
        }

        function missedShot() {
            if (currentPlayer == player1) {
                currentPlayer = player2;
            } else {
                currentPlayer = player1;
            }
            switchPlayerBalls();
            setCurrentPlayer();

            if (currentPlayer == startingPlayer) {
                addInning();
            }

            resetShotClock();
        }

        function timeout() {
            resetShotClock();
            players[currentPlayer].timeouts = (players[currentPlayer].timeouts + 1) % (maxTimeouts+1);
        }

        function nineSnap() {
            confirmBox("9-Snap ends this rack. Cancel if you need to mark any additional balls, otherwise proceed to the next rack.", () => {
                ballStates[ballStates.length - 1] = "won";
                players[currentPlayer].nineSnap = true;
                updateScore();
                advanceToNextRack();
            });
        }

        function nineRun() {
            confirmBox("9-Run ends this rack. Player will earn all rack points.", () => {
                for (var i = 0; i < 9; i++) {
                    ballStates[i] = "won";
                }
                players[currentPlayer].nineRun = true;
                updateScore();
                advanceToNextRack();
            });
        }

        function player1Shooting() {
            if (currentPlayer != player1) {
                switchPlayerBalls();
                currentPlayer = player1;
                setCurrentPlayer();
            }
        }

        function player2Shooting() {
            if (currentPlayer != player2) {
                switchPlayerBalls();
                currentPlayer = player2;
                setCurrentPlayer();
            }
        }

        function addplayer1Defensive() {
            players[player1].rackDefensives++;
            setplayer1Defensives();
        }

        function removeplayer1Defensive() {
            if (players[player1].rackDefensives > 0) {
                players[player1].rackDefensives--;
            }
            setplayer1Defensives();
        }

        function addplayer2Defensive() {
            players[player2].rackDefensives++;
            setplayer2Defensives();
        }

        function removeplayer2Defensive() {
            if (players[player2].rackDefensives > 0) {
                players[player2].rackDefensives--;
            }
            setplayer2Defensives();
        }

        function addInning() {
            currentInnings = currentInnings + 1;
            setInnings();
        }

        function removeInning() {
            if (currentInnings > 0) {
                currentInnings = currentInnings - 1;
            }
            setInnings();
        }

        function setInnings() {
            var matchInningsElement = document.getElementById("match-innings");
            matchInningsElement.innerHTML = currentInnings + matchInnings;
            var inningsElement = document.getElementById("rack-innings");
            inningsElement.innerHTML = currentInnings;
        }

        function updateScore() {
            player1RackScore = 0;
            player2RackScore = 0;
            var parent1 = document.getElementById("player1-balls");
            while (parent1.firstChild) {
                parent1.firstChild.remove();
            }
            var parent2 = document.getElementById("player2-balls");
            while (parent2.firstChild) {
                parent2.firstChild.remove();
            }
            for (var i = 0; i < 9; i++) {
                var ballState = ballStates[i];
                if ((currentPlayer == player1 && ballState == "won") || (currentPlayer == player2 && ballState == "lost")) {
                    player1RackScore += values[i];
                    parent1.appendChild(new BilliardBall(i + 1, ballSizeSmall).element);
                }
                if ((currentPlayer == player1 && ballState == "lost") || (currentPlayer == player2 && ballState == "won")) {
                    player2RackScore += values[i];
                    parent2.appendChild(new BilliardBall(i + 1, ballSizeSmall).element);
                }
            }

            players[player1].score = player1Score + player1RackScore;
            players[player2].score = player2Score + player2RackScore;
        }

        function setplayer1Defensives() {
            var sdElement = document.getElementById("player1-defensives");
            sdElement.innerHTML = players[player1].rackDefensives + players[player1].matchDefensives;
        }

        function setplayer2Defensives() {
            var odElement = document.getElementById("player2-defensives");
            odElement.innerHTML = players[player2].rackDefensives + players[player2].matchDefensives;
        }

        function advanceToNextRack() {
            for (var i = 0; i < 9; i++) {
                var ballState = ballStates[i];
                if ((currentPlayer == player1 && ballState == "won") || (currentPlayer == player2 && ballState == "lost")) {
                    player1Score += values[i];
                }
                if ((currentPlayer == player1 && ballState == "lost") || (currentPlayer == player2 && ballState == "won")) {
                    player2Score += values[i];
                }
            }

            for (const [key, value] of Object.entries(players)) {
                value.rackScore = 0;
                value.rackTimeouts.push(value.timeouts);
                value.nineSnaps.push(value.nineSnap);
                value.nineRuns.push(value.nineRun);
                value.matchDefensives += value.rackDefensives;
            }
            innings.push(currentInnings);
            players[player1].scores.push(player1RackScore);
            players[player2].scores.push(player2RackScore);

            matchInnings += currentInnings;
            clearRack();
            updateScore();
        }

        function nextRack() {
            confirmBox("Advance to the next rack?", advanceToNextRack);
        }

        function setCurrentPlayer() {
            var player1Cue = document.getElementById("player1-cue");
            var player2Cue = document.getElementById("player2-cue");
            var player1Input = document.getElementById("player1-input");
            var player2Input = document.getElementById("player2-input");
            if (currentPlayer == player1) {
                player1Cue.style.visibility = "visible";
                player2Cue.style.visibility = "hidden";
                player1Input.style.fontWeight = "bold";
                player2Input.style.fontWeight = "normal";
            } else {
                player1Cue.style.visibility = "hidden";
                player2Cue.style.visibility = "visible";
                player1Input.style.fontWeight = "normal";
                player2Input.style.fontWeight = "bold";
            }
        }

        function updateBallState(number) {
            var currentBallState = ballStates[number - 1];
            var ball = balls[number];

            switch (currentBallState) {
                case "normal":
                    ball.showNormal();
                    break;

                case "dead":
                    ball.showFoul();
                    break;

                default:
                    ball.showPocketed(currentBallState == "won");
                    break;
            }
        }

        function createScoresRow(player) {
            var row = document.createElement('tr');
            var hdr = document.createElement('td');
            hdr.style.fontWeight = 'bold';
            hdr.innerText = player.displayName;
            row.appendChild(hdr);
            for (var i = 0; i < player.scores.length; i++) {
                var cell = document.createElement('td');
                cell.innerText = player.scores[i].toString();
                if (player.nineSnaps[i]) {
                    var ns = document.createElement('small');
                    ns.innerText = '(9-Snap)';
                    cell.appendChild(ns);
                }
                if (player.nineRuns[i]) {
                    var nr = document.createElement('small');
                    nr.innerText = '(9-Run)';
                    cell.appendChild(nr);
                }
                if (player.rackTimeouts[i] > 0) {
                    var to = document.createElement('sup');
                    to.innerText = 'T'.repeat(player.rackTimeouts[i]);
                    cell.appendChild(to);
                }
                row.appendChild(cell);
            }
            return row;
        }

        function showMatch() {
            var table = document.getElementById('running-score');
            while (table.firstChild) {
                table.firstChild.remove();
            }

            table.appendChild(createScoresRow(players[player1]));
            var row = document.createElement('tr');
            var hdr = document.createElement('td');
            hdr.innerText = 'Innings';
            row.appendChild(hdr);
            for (var i = 0; i < innings.length; i++) {
                var cell = document.createElement('td');
                cell.innerText = innings[i].toString();
                row.appendChild(cell);
            }
            table.appendChild(row);
            row = document.createElement('tr');
            hdr = document.createElement('td');
            hdr.innerText = 'Dead';
            row.appendChild(hdr);
            for (var j = 0; j < players[player1].scores.length; j++) {
                var cell2 = document.createElement('td');
                cell2.innerText = (10 - (players[player1].scores[j] + players[player2].scores[j])).toString();
                row.appendChild(cell2);
            }
            table.appendChild(row);
            table.appendChild(createScoresRow(players[player2]));

            document.getElementById('matchInfo').style.visibility = 'visible';
        }

        function ballClick(number) {
            var currentBallState = ballStates[number - 1];

            var nextBallState = cycle[currentBallState];
            ballStates[number - 1] = nextBallState;

            updateBallState(number);
            updateScore();
            resetShotClock();
        }

        function addMiss(parentId, size) {
            var parentElement = document.getElementById(parentId);
            parentElement.appendChild(new CueBall(size, "End Turn", missedShot).element);
        }

        function addTimeout(parentId, size) {
            var parentElement = document.getElementById(parentId);
            parentElement.appendChild(new CueBall(size, "Time-out", timeout, "yellow").element);
        }

        function add9Snap(parentId, size) {
            var parentElement = document.getElementById(parentId);
            parentElement.appendChild(new BilliardBallWithClick(9, size, nineSnap, "Snap").element);
        }

        function add9Run(parentId, size) {
            var parentElement = document.getElementById(parentId);
            parentElement.appendChild(new BilliardBallWithClick(9, size, nineRun, "Run").element);
        }

        function addRack(parentId, size) {
            var parentElement = document.getElementById(parentId);
            parentElement.appendChild(new Rack(size, "Next Rack", nextRack).element);
        }


        function addBalls(elementId) {
            var parentElement = document.getElementById(elementId);
            for (var i = 1; i <= ballCount; i++) {

                balls[i] = new BilliardBallWithState(i, ballSizeLarge, ballClick, 'DEAD');
                parentElement.appendChild(balls[i].element);
            }

            addMiss(elementId, ballSizeLarge);
            addTimeout(elementId, ballSizeLarge);
            add9Snap(elementId, ballSizeLarge);
            add9Run(elementId, ballSizeLarge);
            addRack(elementId, ballSizeLarge);
        }

        function initialCaps(str) {
            return str[0].toUpperCase() + str.substring(1);
        }

        function onLoad() {
            document.title = isApa ? 'Scoreboard for APA-Style 9-Ball' : 'Scoreboard for Classic 9-Ball';
            addBalls("balls");
            onResize();
            var player1Obj = players[player1];
            bindInput(player1Obj,
                "name",
                document.getElementById("player1-input"),
                function () {
                    var name = player1Obj.name;
                    player1Obj.displayName = initialCaps(name);
                    if (player1Obj.displayName != name) {
                        player1Obj.name = player1Obj.displayName;
                    };
                });
            var player2Obj = players[player2];
            bindInput(player2Obj, "name", document.getElementById("player2-input"), function () {
                var name = player2Obj.name;
                player2Obj.displayName = initialCaps(name);
                if (player2Obj.displayName != name) {
                    player2Obj.name = player2Obj.displayName;
                };
            });

            bindInput(players[player1], "neededToWin", document.getElementById("player1-goal"), function () {
                players[player1].updateScore();
            });

            bindInput(players[player2], "neededToWin", document.getElementById("player2-goal"), function () {
                players[player2].updateScore();
            });

            bindOutput(players[player1], "score", document.getElementById("player1-score"), function () {
                players[player1].updateScore();
            });
            bindOutput(players[player2], "score", document.getElementById("player2-score"), function () {
                players[player2].updateScore();
            });

            bindOutput(players[player1], "remaining", document.getElementById("player1-needs"));
            bindOutput(players[player2], "remaining", document.getElementById("player2-needs"));

            bindOutput(players[player1], "timeouts", document.getElementById("player1-timeouts"));
            bindOutput(players[player2], "timeouts", document.getElementById("player2-timeouts"));

            setCurrentPlayer();
            setInterval(updateClock, 1000);
        }

        function onResize() {
            var width = document.documentElement.clientWidth;
            if (width > 1000) {
                ballSizeLarge = '9%';
                ballSizeSmall = '32px';
            } else if (width > 800) {
                ballSizeLarge = '9%';
                ballSizeSmall = '30px';
            } else if (width > 600) {
                ballSizeLarge = '20%';
                ballSizeSmall = '25px';
            } else {
                ballSizeLarge = '20%';
                ballSizeSmall = '20px';
            }

            var parentElement = document.getElementById("balls");
            parentElement.querySelectorAll('svg').forEach(function (svg) {
                svg.setAttribute('width', ballSizeLarge);
            });

            updateScore();
        }

        function resetShotClock() {
            shotTime = new Date();
        }

        function updateClock() {
            var todClock = document.getElementById("todClock");
            var now = new Date();

            todClock.innerText = now.getHours().toString().padStart(2, '0') + ":" +
                now.getMinutes().toString().padStart(2, '0');

            if (started) {
                var shotElapsed = (now - shotTime)/1000;
                var matchElapsed = (now - matchTime)/60000;
                var shotClock = document.getElementById("shotClock");
                var matchClock = document.getElementById("matchClock");
                shotClock.innerText = Math.round((shotElapsed / 60)).toString() + ":" +
                    Math.round((shotElapsed % 60)).toString().padStart(2, '0');
                matchClock.innerText = Math.round((matchElapsed / 60)).toString() + ":" +
                    Math.round((matchElapsed % 60)).toString().padStart(2, '0');
            }
        }

        var popupAction;

        function onPopupOkClick(id) {
            document.getElementById(id).style.visibility = 'hidden';
            popupAction();
        }

        function confirmBox(message, action) {
            document.getElementById('popupMessage').innerText = message;
            popupAction = action;
            document.getElementById('popup').style.visibility = 'visible';
        }
    </script>
</head>
<body onload='onLoad()'>
    <div class="main" style="background-color: lightblue; min-height: 100vh;  ">
        <table>
            <tr>
                <td>
                    <button onclick="startMatchIfConfirmed()">Start Match</button>
                </td>
                <td style="text-align: center">Total Innings</td>
                <td style="text-align: center">Rack Innings</td>
                <td rowspan="2"><button onclick="showMatch()"><small>Summary</small></button></td>
            </tr>
            <tr>
                <td>
                    <button onclick="clearRackIfConfirmed()">Clear Rack</button>
                </td>
                <td style="text-align: center">
                    <span id="match-innings">0</span>
                </td>
                <td style="text-align: center">
                    <span id="rack-innings">0</span>
                    <button onclick="addInning()"><b>+</b></button>
                    <button onclick="removeInning()"><b>-</b></button>
                </td>

            </tr>
        </table>
        <table class="player">
            <tr>
                <td>Player &amp;<br />Current Shooter</td>
                <td><br/>Score</td>
                <td>Current<br />Rack</td>
                <td><small>Defensives<br />&amp;timeouts</small></td>
            </tr>
            <tr>
                <td class="player-cell">
                    <div style="display: flex; white-space: nowrap">
                        <button style="vertical-align: middle; background: transparent; border: gray;" onclick="player1Shooting()">
                            <svg id="player1-cue" width="25" height="25" style="vertical-align: bottom; visibility: visible; filter: drop-shadow(3px 3px 3px)"><circle cx="11" cy="11" r="10" style="fill: white; stroke: black; stroke-width: 1px" /></svg>
                        </button>
                        &nbsp;
                        <input type="text" id="player1-input" size="8" style="background: transparent; border: transparent;" />
                    </div>
                    <div class="points-needed">
                        <small>Needs&nbsp;</small>
                        <span id="player1-needs">0</span>/
                        <input type="number" min="0" max="99" id="player1-goal" style="background: transparent; border: transparent;" />
                    </div>
                </td>
                <td class="player-cell" style="text-align: center; padding-top: 5px; "><span id="player1-score">0</span></td>
                <td class="player-cell"><div id="player1-balls" style="padding-top: 3px; padding-left: 3px;"></div></td>
                <td class="player-cell" style="text-align: center; padding-top: 3px; ">
                    <span id="player1-defensives">0</span>
                    <button class="player-button" onclick="addplayer1Defensive()"><b>+</b></button>
                    <button class="player-button" onclick="removeplayer1Defensive()"><b>-</b></button>
                    <br /><small>t/o:&nbsp;<span id="player1-timeouts">0</span></small>
                </td>
            </tr>
            <tr>
                <td class="player-cell">
                    <div style="display: flex; white-space: nowrap">
                        <button style="vertical-align: middle; background: transparent; border: gray;" onclick="player2Shooting()">
                            <svg id="player2-cue" width="25" height="25" style="vertical-align: bottom; visibility: hidden; filter: drop-shadow(3px 3px 3px)"><circle cx="11" cy="11" r="10" style="fill: white; stroke: black; stroke-width: 1px" /></svg>
                        </button>
                        &nbsp;
                        <input type="text" id="player2-input" size="8" style="background: transparent; border: transparent;" />
                    </div>
                    <div class="points-needed">
                        <small>Needs&nbsp;</small>
                        <span id="player2-needs">0</span>/
                        <input type="number" min="0" max="99" id="player2-goal" style="background: transparent; border: transparent;" />
                    </div>
                </td>
                <td class="player-cell" style="text-align: center; padding-top: 5px;"><span id="player2-score">0</span></td>
                <td class="player-cell"><div id="player2-balls" style="padding-top: 3px; padding-left: 3px;"></div></td>
                <td class="player-cell" style="text-align: center; padding-top: 3px ">
                    <div class="defensives">
                        <span id="player2-defensives">0</span>
                        <button class="player-button" onclick="addplayer2Defensive()"><b>+</b></button>
                        <button class="player-button" onclick="removeplayer2Defensive()"><b>-</b></button>
                        <br /><small>t/o:&nbsp;<span id="player2-timeouts">0</span></small>
                    </div>
                </td>
            </tr>
        </table>
        <div id="balls" style="padding: 10px;  ">
        </div>
        <div id="clocks">
            <table>
                <tr>
                    <td><button onclick="resetShotClock()">Shot</button></td>
                    <td>Match</td>
                </tr>
                <tr>
                    <td><span id="shotClock">0:00</span></td>
                    <td><span id="matchClock">0:00</span></td>
                    <td><span id="todClock">0:00</span></td>
                </tr>
            </table>
        </div>
        <div id="popup" class="popupBackground" style="visibility: hidden">
            <div class="popup">
                <p id="popupMessage" style="text-align: center"></p>
                <div class="popupButtons">
                    <button onclick="onPopupOkClick('popup')">OK</button>&nbsp;<button onclick="(()=>{document.getElementById('popup').style.visibility = 'hidden'})()">Cancel</button>
                </div>
            </div>
        </div>
        
        <div id="matchInfo" class="popupBackground" style="visibility: hidden">
            <div class="popup-large">
                <p align="center">Summary of completed racks.<br/><small>Does not include the rack in progress. Best viewed in landscape orientation.</small></p>
                <table id="running-score" class="running-score">
                </table>
                <div class="popupButtons">
                    <button onclick="(() => { document.getElementById('matchInfo').style.visibility = 'hidden' })()">OK</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>