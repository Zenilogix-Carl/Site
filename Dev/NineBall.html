<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <style>
        .buttons {
            padding-left: 10px;
            padding-right: 10px;
            padding-top: 3px;
            padding-bottom: 3px;
        }

        input {
            font-size: 20pt;
        }

        button {
            font-size: 18pt;
        }

        table, th, td {
            border: 1px solid grey;
            border-collapse: collapse;
        }

        td {
            padding-left: 5px;
            padding-right: 5px;
            padding-top: 1px;
            padding-bottom: 1px;
        }

        body {
            font-family: Verdana, sans-serif;
            font-size: 20pt;
            padding: 0px;
            margin: 0px;
            overflow-x: hidden;
            overflow-y: hidden;
        }
    </style>
    <script src="Billiards.js"></script>
    <script>
        class NineBallPlayer extends Player {
            constructor(name, setupFn) {
                super(name, setupFn);

                this.score = 0;
                this.neededToWin = 0;
            }

            bindScore(htmlElement) {
                this.scoreElement = htmlElement;
            }

            getScore() {
                return this.score;
            }

            setScore(score) {
                this.score = score;
                this.updateScore();
            }

            updateScore() {
                this.scoreElement.innerHTML = this.score;
                var remaining = this.neededToWin - this.score;
                this.remainingElement.innerHTML = remaining > 0 ? remaining : 0;
            }

            bindNeededToWin(inputElement, htmlElement) {
                var obj = this;
                inputElement.oninput = function () {
                    obj.neededToWin = inputElement.value;
                    obj.updateScore();
                }
                this.remainingElement = htmlElement;
            }
        }

        const ballCount = 9;
        const apa = [1, 1, 1, 1, 1, 1, 1, 1, 2];
        const traditional = [0, 0, 0, 0, 0, 0, 0, 0, 1];

        const player1 = "player1";
        const player2 = "player2";

        var qs = location.search.substring(1).split('&');
        var qqs = {};
        qs.forEach((nvp) => {
            var e = nvp.split('=');
            if (e.length == 2) {
                qqs[e[0].trim()] = e[1].trim();
            }
        });

        var values = (!(qqs['style'] === undefined) && qqs['style'].toLowerCase() == 'apa') ? apa : traditional;
        var balls = {};
        var ballStates = Array(ballCount).fill("normal");

        var player1Name = "Self";
        var player2Name = "Opponent";

        var cycle = {
            "normal": "won",
            "won": "dead",
            "dead": "lost",
            "lost": "normal"
        };

        var invert = {
            "normal": "normal",
            "won": "lost",
            "dead": "dead",
            "lost": "won"
        };

        var matchInnings = 0;
        var currentInnings = 0;
        var matchplayer1Defensives = 0;
        var matchplayer2Defensives = 0;
        var currentplayer1Defensives = 0;
        var currentplayer2Defensives = 0;
        var currentPlayer = player1;
        var startingPlayer = currentPlayer;
        var player1Score = 0;
        var player2Score = 0;
        var player1RackScore = 0;
        var player2RackScore = 0;

        var players = {
            player1: new NineBallPlayer("Self"),
            player2: new NineBallPlayer("Opponent")
        }


        function clearRackIfConfirmed() {
            if (window.confirm("Reset the current rack?")) {
                clearRack();
            }
        }

        function clearRack() {
            ballStates = Array(ballCount).fill("normal");
            for (var i = 1; i <= ballCount; i++) {
                updateBallState(i);
            }

            currentInnings = 0;
            currentplayer1Defensives = 0;
            currentplayer2Defensives = 0;
            updateScore();
            setInnings();
            setplayer1Defensives();
            setplayer2Defensives();
        }

        function startMatchIfConfirmed() {
            if (window.confirm("Start a new match (clear current status)?")) {
                startMatch();
            }
        }

        function startMatch() {
            ballStates = Array(ballCount).fill("normal");
            player1Score = 0;
            player2Score = 0;
            player1RackScore = 0;
            player2RackScore = 0;
            clearRack();
            matchInnings = 0;
            currentInnings = 0;
            currentplayer1Defensives = 0;
            currentplayer2Defensives = 0;
            matchplayer1Defensives = 0;
            matchplayer2Defensives = 0;
            startingPlayer = currentPlayer;
            setInnings();
            setplayer1Defensives();
            setplayer2Defensives();
        }

        function switchPlayerBalls() {
            for (var i = 0; i < ballCount; i++) {
                ballStates[i] = invert[ballStates[i]];
                updateBallState(i + 1);
            }
        }

        function missedShot() {
            if (currentPlayer == player1) {
                currentPlayer = player2;
            } else {
                currentPlayer = player1;
            }
            switchPlayerBalls();
            setCurrentPlayer();

            if (currentPlayer == startingPlayer) {
                addInning();
            }
        }

        function player1Shooting() {
            if (currentPlayer != player1) {
                switchPlayerBalls();
                currentPlayer = player1;
                setCurrentPlayer();
            }
        }

        function player2Shooting() {
            if (currentPlayer != player2) {
                switchPlayerBalls();
                currentPlayer = player2;
                setCurrentPlayer();
            }
        }

        function addplayer1Defensive() {
            currentplayer1Defensives++;
            setplayer1Defensives();
        }

        function removeplayer1Defensive() {
            if (currentplayer1Defensives > 0) {
                currentplayer1Defensives--;
            }
            setplayer1Defensives();
        }

        function addplayer2Defensive() {
            currentplayer2Defensives++;
            setplayer2Defensives();
        }

        function removeplayer2Defensive() {
            if (currentplayer2Defensives > 0) {
                currentplayer2Defensives--;
            }
            setplayer2Defensives();
        }

        function addInning() {
            currentInnings = currentInnings + 1;
            setInnings();
        }

        function removeInning() {
            if (currentInnings > 0) {
                currentInnings = currentInnings - 1;
            }
            setInnings();
        }

        function setInnings() {
            var matchInningsElement = document.getElementById("match-innings");
            matchInningsElement.innerHTML = currentInnings + matchInnings;
            var inningsElement = document.getElementById("rack-innings");
            inningsElement.innerHTML = currentInnings;
        }

        function updateScore() {
            player1RackScore = 0;
            player2RackScore = 0;
            var parent1 = document.getElementById("player1-balls");
            while (parent1.firstChild) {
                parent1.firstChild.remove();
            }
            var parent2 = document.getElementById("player2-balls");
            while (parent2.firstChild) {
                parent2.firstChild.remove();
            }
            for (var i = 0; i < 9; i++) {
                var ballState = ballStates[i];
                if ((currentPlayer == player1 && ballState == "won") || (currentPlayer == player2 && ballState == "lost")) {
                    player1RackScore += values[i];
                    parent1.appendChild(new BilliardBall(i+1, '30px').element);
                }
                if ((currentPlayer == player1 && ballState == "lost") || (currentPlayer == player2 && ballState == "won")) {
                    player2RackScore += values[i];
                    parent2.appendChild(new BilliardBall(i + 1, '30px').element);
                }
            }

            players[player1].setScore(player1Score + player1RackScore);
            players[player2].setScore(player2Score + player2RackScore);
        }

        function setplayer1Defensives() {
            var sdElement = document.getElementById("player1-defensives");
            sdElement.innerHTML = currentplayer1Defensives + matchplayer1Defensives;
        }

        function setplayer2Defensives() {
            var odElement = document.getElementById("player2-defensives");
            odElement.innerHTML = currentplayer2Defensives + matchplayer2Defensives;
        }

        function nextRack() {
            if (window.confirm("Advance to the next rack?")) {
                for (var i = 0; i < 9; i++) {
                    var ballState = ballStates[i];
                    if ((currentPlayer == player1 && ballState == "won") || (currentPlayer == player2 && ballState == "lost")) {
                        player1Score += values[i];
                    }
                    if ((currentPlayer == player1 && ballState == "lost") || (currentPlayer == player2 && ballState == "won")) {
                        player2Score += values[i];
                    }
                }

                matchInnings += currentInnings;
                matchplayer1Defensives += currentplayer1Defensives;
                matchplayer2Defensives += currentplayer2Defensives;
                clearRack();
                updateScore();
            }
        }

        function setCurrentPlayer() {
            var player1Cue = document.getElementById("player1-cue");
            var player2Cue = document.getElementById("player2-cue");
            if (currentPlayer == player1) {
                player1Cue.style.visibility = "visible";
                player2Cue.style.visibility = "hidden";
            } else {
                player1Cue.style.visibility = "hidden";
                player2Cue.style.visibility = "visible";
            }
        }

        function updateBallState(number) {
            var currentBallState = ballStates[number - 1];
            var ball = balls[number];

            switch (currentBallState) {
                case "normal":
                    ball.showNormal();
                    break;

                case "dead":
                    ball.showFoul();
                    break;

                default:
                    ball.showPocketed(currentBallState == "won");
                    break;
            }
        }

        function ballClick(number) {
            var currentBallState = ballStates[number - 1];

            var nextBallState = cycle[currentBallState];
            ballStates[number - 1] = nextBallState;

            updateBallState(number);
            updateScore();
        }

        function addMiss(parentId, size) {
            var parentElement = document.getElementById(parentId);
            parentElement.appendChild(new CueBall(size, "End Turn", missedShot).element);
        }

        function addRack(parentId, size) {
            var parentElement = document.getElementById(parentId);
            parentElement.appendChild(new Rack(size, "Next Rack", nextRack).element);
        }


        function addBalls(elementId) {
            var parentElement = document.getElementById(elementId);
            for (var i = 1; i <= ballCount; i++) {

                balls[i] = new BilliardBallWithState(i, '20%', ballClick, 'DEAD');
                parentElement.appendChild(balls[i].element);
            }

            addMiss(elementId, '20%');
            addRack(elementId, '20%');
        }

        function onLoad() {
            addBalls("balls");
            document.getElementById("player1-input").value = player1Name;
            document.getElementById("player2-input").value = player2Name;

            players[player1].bindScore(document.getElementById("player1-score"));
            players[player1].bindNeededToWin(
                document.getElementById("player1-goal"),
                document.getElementById("player1-needs"));
            players[player2].bindScore(document.getElementById("player2-score"));
            players[player2].bindNeededToWin(
                document.getElementById("player2-goal"),
                document.getElementById("player2-needs"));

        }

    </script>
</head>
<body onload='onLoad()'>
<div style="background-color: lightblue; padding: 20px; min-height: 100vh;  ">
    <table >
        <tr>
            <td>
                <button onclick="startMatchIfConfirmed()">Start Match</button>
            </td>
            <td style="text-align: center">Total Innings</td>
            <td style="text-align: center">Rack Innings</td>

        </tr>
        <tr>
            <td>
                <button onclick="clearRackIfConfirmed()">Clear Rack</button>
            </td>
            <td style="text-align: center">
                <span id="match-innings">0</span>
            </td>
            <td style="text-align: center">
                <span id="rack-innings">0</span>
                <button class="buttons" onclick="addInning()"><b>+</b></button>
                <button class="buttons" onclick="removeInning()"><b>-</b></button>
            </td>

        </tr>
    </table>
    <table>
        <tr>
            <td>Player/Current Shooter</td>
            <td colspan="2">Needed to Win</td>
            <td>Score</td>
            <td>Current Rack</td>
            <td>Defensives</td>
        </tr>
        <tr>
            <td>
                <div style="display: flex; white-space: nowrap">
                    <button style="vertical-align: middle" onclick="player1Shooting()">
                        <svg id="player1-cue" width="25" height="25" style="vertical-align: bottom; visibility: visible; filter: drop-shadow(3px 3px 3px)"><circle cx="11" cy="11" r="10" style="fill: white; stroke: black; stroke-width: 1px" /></svg>
                    </button>
                    &nbsp;
                    <input type="text" id="player1-input" size="15" />
                </div>
            </td>
            <td style="text-align: right">
                <span id="player1-needs"></span>/
            </td>
            <td>
                <input type="text" id="player1-goal" size="2" />
            </td>
            <td style="text-align: center"><span id="player1-score">0</span></td>
            <td><div id="player1-balls" style="padding-top: 3px; padding-left: 3px; padding-bottom: 0px"></div></td>
            <td style="text-align: center">
                <span id="player1-defensives">0</span>
                <button class="buttons" onclick="addplayer1Defensive()"><b>+</b></button>
                <button class="buttons" onclick="removeplayer1Defensive()"><b>-</b></button>
            </td>
        </tr>
        <tr>
            <td>
                <div style="display: flex; white-space: nowrap">
                    <button style="vertical-align: middle" onclick="player2Shooting()">
                        <svg id="player2-cue" width="25" height="25" style="vertical-align: bottom; visibility: hidden; filter: drop-shadow(3px 3px 3px)"><circle cx="11" cy="11" r="10" style="fill: white; stroke: black; stroke-width: 1px" /></svg>
                    </button>
                    &nbsp;
                    <input type="text" id="player2-input" size="15"  />
                </div>
            </td>
            <td style="text-align: right">
                <span id="player2-needs"></span>/
            </td>
            <td>
                <input type="text" id="player2-goal" size="2" />
            </td>
            <td style="text-align: center"><span id="player2-score">0</span></td>
            <td><div id="player2-balls" style="padding-top: 3px; padding-left: 3px; padding-bottom: 0px"></div></td>
            <td style="text-align: center">
                <span id="player2-defensives">0</span>
                <button class="buttons" onclick="addplayer2Defensive()"><b>+</b></button>
                <button class="buttons" onclick="removeplayer2Defensive()"><b>-</b></button>
            </td>
        </tr>
    </table>
    <div id="balls" style="background-color: lightblue; padding: 10px; max-width: 800px; max-height: 95%; aspect-ratio: 4 / 3; " >
    </div>
</div>
</body>
</html>